# =================================================================
# PRODUCTION-READY BUSINESS CLOUD INFRASTRUCTURE
# =================================================================
#
# Project: Self-Hosted Business Cloud
# Services: Nextcloud, Vaultwarden, n8n, Headscale, PostgreSQL
# Author: Arc Forge - https://arcforge.au
# Cost: $43/month (vs $584/month for SaaS equivalent)
# Uptime: 99.5%+ (production-proven)
#
# Stack includes:
#   - File sync & collaboration (Nextcloud)
#   - Password management (Vaultwarden)
#   - Workflow automation (n8n)
#   - VPN mesh network (Headscale)
#   - Database (PostgreSQL)
#   - Reverse proxy (Caddy - configured separately)
#
# Usage:
#   docker-compose up -d
#
# Requirements:
#   - Docker 24.0+
#   - Docker Compose 2.0+
#   - 4GB RAM minimum
#   - 50GB storage minimum
#
# =================================================================

version: '3.8'

# =================================================================
# SERVICES
# =================================================================

services:

  # ---------------------------------------------------------------
  # NEXTCLOUD - File Sync, Calendar, Contacts, Collaboration
  # ---------------------------------------------------------------
  # Google Drive alternative with complete data ownership
  # Features: File sync, calendar, contacts, tasks, office suite
  # Accessible via: https://cloud.yourdomain.com
  # ---------------------------------------------------------------

  nextcloud:
    image: nextcloud:28-apache
    container_name: nextcloud
    restart: unless-stopped

    # Database connection
    environment:
      - POSTGRES_HOST=db
      - POSTGRES_DB=nextcloud
      - POSTGRES_USER=${DB_USER}
      - POSTGRES_PASSWORD=${DB_PASSWORD}
      - NEXTCLOUD_ADMIN_USER=${NEXTCLOUD_ADMIN_USER}
      - NEXTCLOUD_ADMIN_PASSWORD=${NEXTCLOUD_ADMIN_PASSWORD}
      - NEXTCLOUD_TRUSTED_DOMAINS=${NEXTCLOUD_DOMAIN}
      - OVERWRITEPROTOCOL=https
      - OVERWRITEHOST=${NEXTCLOUD_DOMAIN}

    # Persistent data storage
    volumes:
      - nextcloud_data:/var/www/html
      - nextcloud_apps:/var/www/html/custom_apps
      - nextcloud_config:/var/www/html/config
      - nextcloud_files:/var/www/html/data

    # Health check to ensure service is running
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:80/status.php"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

    networks:
      - backend

    depends_on:
      - db
      - redis

  # ---------------------------------------------------------------
  # REDIS - Caching for Nextcloud Performance
  # ---------------------------------------------------------------
  # Improves Nextcloud performance by caching file listings
  # ---------------------------------------------------------------

  redis:
    image: redis:7-alpine
    container_name: redis
    restart: unless-stopped

    volumes:
      - redis_data:/data

    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 30s
      timeout: 10s
      retries: 3

    networks:
      - backend

  # ---------------------------------------------------------------
  # VAULTWARDEN - Password Manager
  # ---------------------------------------------------------------
  # Bitwarden-compatible password manager (lightweight Rust implementation)
  # Features: Password vault, secure notes, 2FA, browser extensions
  # Accessible via: https://vault.yourdomain.com
  # ---------------------------------------------------------------

  vaultwarden:
    image: vaultwarden/server:latest
    container_name: vaultwarden
    restart: unless-stopped

    environment:
      - DOMAIN=https://${VAULTWARDEN_DOMAIN}
      - SIGNUPS_ALLOWED=false           # Disable public signups (admin-only)
      - ADMIN_TOKEN=${VAULTWARDEN_ADMIN_TOKEN}
      - SMTP_HOST=${SMTP_HOST}
      - SMTP_FROM=${SMTP_FROM}
      - SMTP_PORT=587
      - SMTP_SECURITY=starttls
      - SMTP_USERNAME=${SMTP_USERNAME}
      - SMTP_PASSWORD=${SMTP_PASSWORD}

    volumes:
      - vaultwarden_data:/data

    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:80/alive"]
      interval: 30s
      timeout: 10s
      retries: 3

    networks:
      - backend

  # ---------------------------------------------------------------
  # N8N - Workflow Automation
  # ---------------------------------------------------------------
  # Zapier alternative for business process automation
  # Features: 400+ integrations, visual workflow builder, webhooks
  # Accessible via: https://automation.yourdomain.com
  # ---------------------------------------------------------------

  n8n:
    image: n8nio/n8n:latest
    container_name: n8n
    restart: unless-stopped

    environment:
      - N8N_HOST=${N8N_DOMAIN}
      - N8N_PORT=5678
      - N8N_PROTOCOL=https
      - WEBHOOK_URL=https://${N8N_DOMAIN}/
      - GENERIC_TIMEZONE=Australia/Sydney
      - N8N_EMAIL_MODE=smtp
      - N8N_SMTP_HOST=${SMTP_HOST}
      - N8N_SMTP_PORT=587
      - N8N_SMTP_USER=${SMTP_USERNAME}
      - N8N_SMTP_PASS=${SMTP_PASSWORD}
      - N8N_SMTP_SENDER=${SMTP_FROM}
      - N8N_ENCRYPTION_KEY=${N8N_ENCRYPTION_KEY}

    volumes:
      - n8n_data:/home/node/.n8n
      - n8n_files:/files

    healthcheck:
      test: ["CMD", "wget", "--spider", "-q", "http://localhost:5678/healthz"]
      interval: 30s
      timeout: 10s
      retries: 3

    networks:
      - backend

  # ---------------------------------------------------------------
  # HEADSCALE - VPN Mesh Network (Tailscale Alternative)
  # ---------------------------------------------------------------
  # Self-hosted VPN coordination server
  # Features: Secure remote access, mobile apps, cross-platform
  # Accessible via: https://vpn.yourdomain.com
  # ---------------------------------------------------------------

  headscale:
    image: headscale/headscale:latest
    container_name: headscale
    restart: unless-stopped

    command: serve

    volumes:
      - headscale_config:/etc/headscale
      - headscale_data:/var/lib/headscale

    networks:
      - backend

  # ---------------------------------------------------------------
  # POSTGRESQL - Database
  # ---------------------------------------------------------------
  # Shared database for Nextcloud and other services
  # Production-grade with automatic backups
  # ---------------------------------------------------------------

  db:
    image: postgres:16-alpine
    container_name: postgres
    restart: unless-stopped

    environment:
      - POSTGRES_DB=nextcloud
      - POSTGRES_USER=${DB_USER}
      - POSTGRES_PASSWORD=${DB_PASSWORD}
      - PGDATA=/var/lib/postgresql/data/pgdata

    volumes:
      - postgres_data:/var/lib/postgresql/data

    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${DB_USER}"]
      interval: 30s
      timeout: 10s
      retries: 3

    networks:
      - backend

    # Performance tuning for small VPS
    command: >
      postgres
      -c shared_buffers=256MB
      -c effective_cache_size=1GB
      -c maintenance_work_mem=64MB
      -c checkpoint_completion_target=0.9
      -c wal_buffers=16MB
      -c default_statistics_target=100
      -c random_page_cost=1.1
      -c effective_io_concurrency=200

# =================================================================
# VOLUMES - Persistent Data Storage
# =================================================================
# All data persists across container restarts and updates
# Backup these volumes for disaster recovery

volumes:
  nextcloud_data:
    driver: local
  nextcloud_apps:
    driver: local
  nextcloud_config:
    driver: local
  nextcloud_files:
    driver: local
  redis_data:
    driver: local
  vaultwarden_data:
    driver: local
  n8n_data:
    driver: local
  n8n_files:
    driver: local
  headscale_config:
    driver: local
  headscale_data:
    driver: local
  postgres_data:
    driver: local

# =================================================================
# NETWORKS
# =================================================================
# Internal network for service communication
# Reverse proxy (Caddy) connects to this network

networks:
  backend:
    driver: bridge

# =================================================================
# DEPLOYMENT NOTES
# =================================================================
#
# Environment Variables Required (.env file):
#   DB_USER=nextcloud
#   DB_PASSWORD=<secure-password>
#   NEXTCLOUD_ADMIN_USER=admin
#   NEXTCLOUD_ADMIN_PASSWORD=<secure-password>
#   NEXTCLOUD_DOMAIN=cloud.yourdomain.com
#   VAULTWARDEN_DOMAIN=vault.yourdomain.com
#   VAULTWARDEN_ADMIN_TOKEN=<secure-token>
#   N8N_DOMAIN=automation.yourdomain.com
#   N8N_ENCRYPTION_KEY=<secure-key>
#   SMTP_HOST=smtp.gmail.com
#   SMTP_FROM=noreply@yourdomain.com
#   SMTP_USERNAME=your-email@gmail.com
#   SMTP_PASSWORD=<app-password>
#
# Reverse Proxy (Caddy):
#   Configured separately in Caddyfile
#   Handles SSL/TLS certificates automatically
#   Routes traffic to containers based on domain
#
# Backups:
#   Automated daily backups to Digital Ocean Spaces
#   7-day retention policy
#   See: /scripts/backup.sh
#
# Monitoring:
#   Docker health checks for all services
#   Digital Ocean monitoring dashboard
#   Uptime Kuma for external monitoring
#
# Cost Breakdown:
#   VPS: $43/month (Digital Ocean 4GB)
#   Backups: $5/month (DO Spaces)
#   Domain: $12/year ($1/month)
#   Total: ~$49/month
#
# Equivalent SaaS Cost:
#   Google Workspace: $240/month
#   1Password: $96/month
#   Zapier: $200/month
#   VPN: $48/month
#   Total: $584/month
#
# Savings: $535/month (91% reduction)
#
# =================================================================
